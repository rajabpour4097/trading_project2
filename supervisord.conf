[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
user=root

[program:xvfb]
command=/usr/bin/Xvfb :99 -screen 0 1280x800x24
autostart=true
autorestart=true
priority=10
stdout_logfile=/var/log/supervisor/xvfb.out.log
stderr_logfile=/var/log/supervisor/xvfb.err.log
environment=DISPLAY=":99"

[program:fluxbox]
command=/usr/bin/fluxbox
user=wineuser
autostart=true
autorestart=true
priority=20
stdout_logfile=/var/log/supervisor/fluxbox.out.log
stderr_logfile=/var/log/supervisor/fluxbox.err.log
environment=DISPLAY=":99",HOME="/home/wineuser"

[program:vnc]
command=/usr/bin/x11vnc -display :99 -forever -shared -nopw
autostart=true
autorestart=true
priority=30
stdout_logfile=/var/log/supervisor/x11vnc.out.log
stderr_logfile=/var/log/supervisor/x11vnc.err.log

# بار اول: شما از طریق VNC نصب‌کننده mt5setup.exe را اجرا می‌کنید و نصب را تمام می‌کنید.
# پس از نصب، مسیر پیش‌فرض: C:\Program Files\MetaTrader 5\terminal64.exe
[program:mt5]
command=/bin/bash -lc 'export DISPLAY=:99; test -f "/home/wineuser/.wine/drive_c/Program Files/MetaTrader 5/terminal64.exe" && exec sudo -u wineuser wine "C:\\Program Files\\MetaTrader 5\\terminal64.exe" /portable || sleep 5'
user=root
autostart=true
autorestart=true
startretries=999
priority=40
stdout_logfile=/var/log/supervisor/mt5.out.log
stderr_logfile=/var/log/supervisor/mt5.err.log
environment=DISPLAY=":99",HOME="/home/wineuser"

# ربات پایتونی شما؛ پس از بالا آمدن MT5 اجرا می‌شود
[program:bot]
command=/bin/bash -lc 'export DISPLAY=:99; until pgrep -f terminal64.exe >/dev/null; do echo "Waiting for MT5..."; sleep 3; done; cd /app && sudo -u wineuser python3 main_metatrader.py'
autostart=true
autorestart=true
startretries=999
priority=50
stdout_logfile=/var/log/supervisor/bot.out.log
stderr_logfile=/var/log/supervisor/bot.err.log
environment=DISPLAY=":99",HOME="/home/wineuser"